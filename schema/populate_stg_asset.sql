Procedure	sql_mode	Create Procedure	character_set_client	collation_connection	Database Collation
populate_stg_asset	STRICT_TRANS_TABLES	CREATE DEFINER=`data_warehouse`@`172.16.63.%` PROCEDURE `populate_stg_asset`()\n    COMMENT 'USAGE: populate_stg_asset() /* Populates auto_billing_staging.stg_asset - a de-normalized version of sales_force.asset. */'\nBEGIN\n  \n    /* \n        purpose:  create a de-normalized version for sales_force.asset which can be used to facilitate auto_billing.\n        the table will include the account_id, currency_code, date, exchange rate, and a separate column for each fee_name__c present in sales_force.asset.\n        \n        sample row (some fees omitted for brevity):\n        \n        data_warehouse@localhost [auto_billing_staging] select * from stg_asset LIMIT 1\\G\n        *************************** 1. row ***************************\n                           account_id: 0013i00000Cg8RaAAJ\n                    currency_iso_code: EUR\n                            rate_date: 2020-12-01\n                        exchange_rate: 1.22637300\n                       ach_credit_fee: 1.00000\n                  bfach_discount_rate: 3.00000\n                                   ...\n              shieldconex_monthly_fee: 63.00000\n          shieldconex_monthly_minimum: 65.00000\n          shieldconex_transaction_fee: 67.00000\n                         date_updated: 2021-01-11 16:49:33               \n        \n        \n          this procedure will have to be updated when new fees are added to sales_force.asset.\n\n          the exchange rate will change every month.  \n          because auto_billing is generally run on the first business day of the month, the exchange month that is applicable will be the one for the previous month, relative to the current date.\n          for that reason, it is required that the auto_billing_staging.exchange_rate table contains a row for every currency in sales_force.asset for the previous month; \n    \n          sample rows from auto_billing_staging.exchange_rate:\n          \n          +-------------------+------------+---------------+---------------------+\n          | currency_iso_code | rate_date  | exchange_rate | date_processed      |\n          +-------------------+------------+---------------+---------------------+\n          | CAD               | 2020-12-01 |    0.78474300 | 2021-01-11 13:50:21 |\n          | EUR               | 2020-12-01 |    1.22637300 | 2021-01-11 13:54:09 |\n          +-------------------+------------+---------------+---------------------+\n \n     */\n  \n    SELECT 'Executing Stored Procedure' AS operation, 'auto_billing_staging.populate_stg_asset' AS stored_procedure, CURRENT_TIMESTAMP;\n  \n    SELECT 'there should be an exchange rate defined for every currency present in the sales_force.asset table.' AS message UNION SELECT 'NULL values for exchange rate / rate_date indicate that an exchange rate is missing in auto_billing_staging.exchange_rate. ';\n  \n    SELECT\n       asst.currency_iso_code \n      ,er.exchange_rate \n      ,er.rate_date\n      ,COUNT(*) AS num_rows\n      FROM sales_force.asset      asst \n      LEFT JOIN auto_billing_staging.v_exchange_rates_last_month    er \n        ON asst.currency_iso_code = er.currency_iso_code \n     GROUP BY 1, 2, 3\n    ;\n\n\n  SELECT 'every row in sales_force.asset for a given account_id should have the same currency code.' AS message UNION SELECT 'if the number of rows in the table below is non-zero, then the account_id\\'s shown have more than one currency.';\n\n  SELECT * \n    FROM (\n        SELECT \n             accountid \n            ,COUNT(DISTINCT currency_iso_code) AS currency_codes\n          FROM sales_force.asset \n         GROUP BY 1) t1 \n   WHERE currency_codes >= 2\n  ;\n  \n    SELECT 'The following fees are duplicated in sales_force.asset and will causing billing errors unless the duplicates are deleted.' AS message;\n      \n    SELECT * FROM sales_force.v_dupe_fees;\n      \n  \n    TRUNCATE auto_billing_staging.stg_asset;\n  \n    INSERT INTO auto_billing_staging.stg_asset(\n       account_id    \n      ,currency_iso_code \n      ,rate_date \n      ,exchange_rate \n      ,ach_credit_fee               \n      ,bfach_discount_rate          \n      ,ach_per_gw_trans_fee         \n      ,ach_monthly_fee              \n      ,ach_noc_fee                  \n      ,ach_return_error_fee         \n      ,ach_transaction_fee          \n      ,bluefin_gateway_discount_rate\n      ,file_transfer_monthly_fee    \n      ,group_tag_fee                \n      ,gw_per_auth_decline_fee      \n      ,per_transaction_fee          \n      ,gw_per_credit_fee            \n      ,gateway_monthly_fee          \n      ,gw_per_refund_fee            \n      ,gw_reissued_fee              \n      ,gw_per_token_fee             \n      ,gw_per_sale_fee              \n      ,misc_monthly_fees            \n      ,p2pe_device_activated        \n      ,p2pe_device_activating_fee   \n      ,p2pe_device_stored_fee       \n      ,p2pe_encryption_fee          \n      ,p2pe_monthly_flat_fee        \n      ,p2pe_tokenization_fee        \n      ,one_time_key_injection_fees  \n      ,payconex_app_exchange_fee    \n      ,pci_compliance_fee           \n      ,pci_non_compliance_fee       \n      ,pci_scans_monthly_fee        \n      ,shieldconex_fields_fee       \n      ,shieldconex_monthly_fee      \n      ,shieldconex_monthly_minimum  \n      ,shieldconex_transaction_fee  \n      ,tokenization_fee \n      ,date_updated                 )\n    SELECT \n         account_id \n        ,currency_iso_code \n        ,rate_date\n        ,exchange_rate\n        ,SUM(ach_credit_fee)                AS ach_credit_fee\n        ,SUM(bfach_discount_rate)           AS bfach_discount_rate\n        ,SUM(ach_per_gw_trans_fee)          AS ach_per_gw_trans_fee\n        ,SUM(ach_monthly_fee)               AS ach_monthly_fee\n        ,SUM(ach_noc_fee)                   AS ach_noc_fee\n        ,SUM(ach_return_error_fee)          AS ach_return_error_fee\n        ,SUM(ach_transaction_fee)           AS ach_transaction_fee\n        ,SUM(bluefin_gateway_discount_rate) AS bluefin_gateway_discount_rate\n        ,SUM(file_transfer_monthly_fee)     AS file_transfer_monthly_fee\n        ,SUM(group_tag_fee)                 AS group_tag_fee\n        ,SUM(gw_per_auth_decline_fee)       AS gw_per_auth_decline_fee\n        ,SUM(per_transaction_fee)           AS per_transaction_fee\n        ,SUM(gw_per_credit_fee)             AS gw_per_credit_fee\n        ,SUM(gateway_monthly_fee)           AS gateway_monthly_fee\n        ,SUM(gw_per_refund_fee)             AS gw_per_refund_fee\n        ,SUM(gw_reissued_fee)               AS gw_reissued_fee\n        ,SUM(gw_per_token_fee)              AS gw_per_token_fee\n        ,SUM(gw_per_sale_fee)               AS gw_per_sale_fee\n        ,SUM(misc_monthly_fees)             AS misc_monthly_fees\n        ,SUM(p2pe_device_activated)         AS p2pe_device_activated\n        ,SUM(p2pe_device_activating_fee)    AS p2pe_device_activating_fee\n        ,SUM(p2pe_device_stored_fee)        AS p2pe_device_stored_fee\n        ,SUM(p2pe_encryption_fee)           AS p2pe_encryption_fee\n        ,SUM(p2pe_monthly_flat_fee)         AS p2pe_monthly_flat_fee\n        ,SUM(p2pe_tokenization_fee)         AS p2pe_tokenization_fee\n        ,SUM(one_time_key_injection_fees)   AS one_time_key_injection_fees\n        ,SUM(payconex_app_exchange_fee)     AS payconex_app_exchange_fee\n        ,SUM(pci_compliance_fee)            AS pci_compliance_fee\n        ,SUM(pci_non_compliance_fee)        AS pci_non_compliance_fee\n        ,SUM(pci_scans_monthly_fee)         AS pci_scans_monthly_fee\n        ,SUM(shieldconex_fields_fee)        AS shieldconex_fields_fee\n        ,SUM(shieldconex_monthly_fee)       AS shieldconex_monthly_fee\n        ,SUM(shieldconex_monthly_minimum)   AS shieldconex_monthly_minimum\n        ,SUM(shieldconex_transaction_fee)   AS shieldconex_transaction_fee\n        ,SUM(tokenization_fee)              AS tokenization_fee\n        ,MAX(date_updated)                  AS date_updated\n      FROM (\n          SELECT\n               accountid                                                                                    AS account_id\n              ,currency_iso_code                                                                                         AS currency_iso_code\n              ,NULL                                                                                         AS rate_date \n              ,NULL                                                                                         AS exchange_rate\n              ,(COALESCE(fee_name__c, '') = 'ACH Credit Fee')               * COALESCE(fee_amount__c, 0.00) AS ach_credit_fee\n              ,(COALESCE(fee_name__c, '') = 'ACH Discount Rate')            * COALESCE(fee_amount__c, 0.00) AS bfach_discount_rate\n              ,(COALESCE(fee_name__c, '') = 'ACH GW Trans Fee')             * COALESCE(fee_amount__c, 0.00) AS ach_per_gw_trans_fee\n              ,(COALESCE(fee_name__c, '') = 'ACH Monthly Fee')              * COALESCE(fee_amount__c, 0.00) AS ach_monthly_fee\n              ,(COALESCE(fee_name__c, '') = 'ACH NOC Fee')                  * COALESCE(fee_amount__c, 0.00) AS ach_noc_fee\n              ,(COALESCE(fee_name__c, '') = 'ACH Return/Error Fee')         * COALESCE(fee_amount__c, 0.00) AS ach_return_error_fee\n              ,(COALESCE(fee_name__c, '') = 'ACH Transaction Fee')          * COALESCE(fee_amount__c, 0.00) AS ach_transaction_fee\n              ,(COALESCE(fee_name__c, '') = 'Apriva Monthly Fee')           * COALESCE(fee_amount__c, 0.00) AS bluefin_gateway_discount_rate\n              ,(COALESCE(fee_name__c, '') = 'File Transfer Monthly Fee')    * COALESCE(fee_amount__c, 0.00) AS file_transfer_monthly_fee\n              ,(COALESCE(fee_name__c, '') = 'Group/Tag Fee')                * COALESCE(fee_amount__c, 0.00) AS group_tag_fee\n              ,(COALESCE(fee_name__c, '') = 'GW Auth Decline Fee')          * COALESCE(fee_amount__c, 0.00) AS gw_per_auth_decline_fee\n              ,(COALESCE(fee_name__c, '') = 'GW Auth Fee')                  * COALESCE(fee_amount__c, 0.00) AS per_transaction_fee\n              ,(COALESCE(fee_name__c, '') = 'GW Credit Fee')                * COALESCE(fee_amount__c, 0.00) AS gw_per_credit_fee\n              ,(COALESCE(fee_name__c, '') = 'GW Monthly Fee')               * COALESCE(fee_amount__c, 0.00) AS gateway_monthly_fee\n              ,(COALESCE(fee_name__c, '') = 'GW Refund Fee')                * COALESCE(fee_amount__c, 0.00) AS gw_per_refund_fee\n              ,(COALESCE(fee_name__c, '') = 'GW Reissued Fee')              * COALESCE(fee_amount__c, 0.00) AS gw_reissued_fee\n              ,(COALESCE(fee_name__c, '') = 'GW Token Fee')                 * COALESCE(fee_amount__c, 0.00) AS gw_per_token_fee\n              ,(COALESCE(fee_name__c, '') = 'GW Tran Fee')                  * COALESCE(fee_amount__c, 0.00) AS gw_per_sale_fee\n              ,(COALESCE(fee_name__c, '') = 'Misc Monthly Fee(s)')          * COALESCE(fee_amount__c, 0.00) AS misc_monthly_fees\n              ,(COALESCE(fee_name__c, '') = 'P2PE Device Activated Fee')    * COALESCE(fee_amount__c, 0.00) AS p2pe_device_activated\n              ,(COALESCE(fee_name__c, '') = 'P2PE Device Activating Fee')   * COALESCE(fee_amount__c, 0.00) AS p2pe_device_activating_fee\n              ,(COALESCE(fee_name__c, '') = 'P2PE Device Stored Fee')       * COALESCE(fee_amount__c, 0.00) AS p2pe_device_stored_fee\n              ,(COALESCE(fee_name__c, '') = 'P2PE Encryption Fee')          * COALESCE(fee_amount__c, 0.00) AS p2pe_encryption_fee\n              ,(COALESCE(fee_name__c, '') = 'P2PE Monthly Flat Fee')        * COALESCE(fee_amount__c, 0.00) AS p2pe_monthly_flat_fee\n              ,(COALESCE(fee_name__c, '') = 'P2PE Token Fee')               * COALESCE(fee_amount__c, 0.00) AS p2pe_tokenization_fee\n              ,(COALESCE(fee_name__c, '') = 'P2PE Token Flat Monthly Fee')  * COALESCE(fee_amount__c, 0.00) AS one_time_key_injection_fees\n              ,(COALESCE(fee_name__c, '') = 'PayConex AppExchange Fee')     * COALESCE(fee_amount__c, 0.00) AS payconex_app_exchange_fee\n              ,(COALESCE(fee_name__c, '') = 'PCI Management Fee')           * COALESCE(fee_amount__c, 0.00) AS pci_compliance_fee\n              ,(COALESCE(fee_name__c, '') = 'PCI Non-Compliance Fee')       * COALESCE(fee_amount__c, 0.00) AS pci_non_compliance_fee\n              ,(COALESCE(fee_name__c, '') = 'PCI Transaction Fee')          * COALESCE(fee_amount__c, 0.00) AS pci_scans_monthly_fee\n              ,(COALESCE(fee_name__c, '') = 'ShieldConex Fields Fee')       * COALESCE(fee_amount__c, 0.00) AS shieldconex_fields_fee\n              ,(COALESCE(fee_name__c, '') = 'ShieldConex Monthly Fee')      * COALESCE(fee_amount__c, 0.00) AS shieldconex_monthly_fee\n              ,(COALESCE(fee_name__c, '') = 'ShieldConex Monthly Minimum')  * COALESCE(fee_amount__c, 0.00) AS shieldconex_monthly_minimum\n              ,(COALESCE(fee_name__c, '') = 'ShieldConex Transaction Fee')  * COALESCE(fee_amount__c, 0.00) AS shieldconex_transaction_fee\n              ,(COALESCE(fee_name__c, '') = 'Tokenization Fee')             * COALESCE(fee_amount__c, 0.00) AS tokenization_fee\n              ,CURRENT_TIMESTAMP                                                                            AS date_updated\n            FROM sales_force.asset \n      ) t1 \n     GROUP BY 1, 2, 3, 4\n    ;\n    \n    -- we need a 'table' that has all of the rows in auto_billing_staging.exchange_rate \n    -- for which rate_date is between the first of the previous month to the last of the previous month \n    -- relative to the current date.\n    -- a view has been created for this purpose.\n    -- see sample query and data below:\n\n  \n    SELECT * FROM auto_billing_staging.v_exchange_rates_last_month;\n  \n    --     rate_date |currency_iso_code|exchange_rate|\n    --     ----------|-----------------|-------------|\n    --     2020-12-01|CAD              |   0.78474300|\n    --     2020-12-01|EUR              |   1.22637300|\n    --     2020-12-01|USD              |   1.00000000|\n    --     this query was exceuted on 2021-01-20; so the rate_date that time would have been 2020-12-01\n      \n  \n    UPDATE auto_billing_staging.stg_asset                           asst\n      LEFT JOIN auto_billing_staging.v_exchange_rates_last_month    er\n        ON asst.currency_iso_code = er.currency_iso_code \n       SET asst.currency_iso_code = er.currency_iso_code\n          ,asst.rate_date         = er.rate_date\n          ,asst.exchange_rate     = er.exchange_rate\n     WHERE TRUE \n    ;\n    \nEND	utf8	utf8_general_ci	latin1_swedish_ci

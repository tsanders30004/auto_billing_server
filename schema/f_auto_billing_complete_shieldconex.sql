Procedure	sql_mode	Create Procedure	character_set_client	collation_connection	Database Collation
f_auto_billing_complete_shieldconex	STRICT_TRANS_TABLES	CREATE DEFINER=`data_warehouse`@`172.16.63.%` PROCEDURE `f_auto_billing_complete_shieldconex`()\n    COMMENT 'USAGE: f_auto_billing_complete_shieldconex */ Calculates and updates ShieldConex charges and fees. */'\nBEGIN\n\n    -- ShieldConex\n    \n    -- objective:  calculation shieldconex fees\n    \n    SELECT 'Executing Stored Procedure' AS operation, 'f_auto_billing_complete_shieldconex' AS stored_procedure, CURRENT_TIMESTAMP;\n    \n    DROP TABLE IF EXISTS auto_billing_staging.tmp_asset;\n    \n    CREATE TEMPORARY TABLE auto_billing_staging.tmp_asset(\n         client_id                      VARCHAR(32) NOT NULL \n        ,cardconex_acct_id              VARCHAR(18) NOT NULL \n        ,shieldconex_monthly_fee        DECIMAL(12, 5) NOT NULL\n        ,shieldconex_monthly_minimum    DECIMAL(12, 5) NOT NULL\n        ,shieldconex_transaction_fee    DECIMAL(12, 5) NOT NULL\n        ,shieldconex_fields_fee         DECIMAL(12, 5) NOT NULL\n        ,PRIMARY KEY(client_id)\n    );\n    \n    SELECT 'de-normalizing ShieldConex fees' AS message;\n  \n    -- Populate the table\n    INSERT INTO auto_billing_staging.tmp_asset\n    SELECT \n         client_id\n        ,cardconex_acct_id\n        ,SUM(shieldconex_monthly_fee)         AS shieldconex_monthly_fee\n        ,SUM(shieldconex_monthly_minimum)     AS shieldconex_monthly_minimum\n        ,SUM(shieldconex_transaction_fee)     AS shieldconex_transaction_fee\n        ,SUM(shieldconex_fields_charge)       AS shieldconex_fields_charge\n      FROM (\n          SELECT \n             cardconex_acct_id \n            ,client_id \n            ,(fee_name = 'shieldconex_monthly_fee'    ) * fee_amount AS shieldconex_monthly_fee\n            ,(fee_name = 'shieldconex_monthly_minimum') * fee_amount AS shieldconex_monthly_minimum\n            ,(fee_name = 'shieldconex_transaction_fee') * fee_amount AS shieldconex_transaction_fee\n            ,(fee_name = 'shieldconex_fields_fee'  )    * fee_amount AS shieldconex_fields_charge\n          FROM (\n                SELECT \n                    asst.accountid                        AS cardconex_acct_id\n                   ,COALESCE(idn.name, 'undefined')       AS client_id\n                   ,fm.fee                                AS fee_name\n                   ,COALESCE(asst.fee_amount__c, 0.00000) AS fee_amount\n                  FROM sales_force.asset                  asst \n                  JOIN sales_force.fee_map                fm \n                    ON asst.fee_name__c = fm.fee_name\n                  JOIN sales_force.identification_number__c   idn \n                    ON asst.accountid = idn.accountid__c \n                 WHERE fm.fee IN (\n                        'shieldconex_monthly_fee'   \n                       ,'shieldconex_monthly_minimum'\n                       ,'shieldconex_transaction_fee'\n                       ,'shieldconex_fields_fee')\n          ) t1 \n      ) t2 \n     GROUP BY 1, 2\n     ORDER BY 1, 2\n    ; \n    \n    SELECT * FROM auto_billing_staging.tmp_asset;\n    \n    -- Sample Output\n    -- client_id|cardconex_acct_id |shieldconex_monthly_fee|shieldconex_monthly_minimum|shieldconex_transaction_fee|shieldconex_fields_charge|\n    -- ---------|------------------|-----------------------|---------------------------|---------------------------|-------------------------|\n    -- 20       |0013i00000IsUq7AAF|                0.00000|                  250.00000|                    0.02100|                  0.00000|\n    -- 33       |0013i00000QqgelAAB|                0.00000|                 5000.00000|                    0.00175|                  0.00000|\n    \n    \n    -- SELECT\n    --      acct.name\n    --     ,asst.*\n    --   FROM auto_billing_staging.tmp_asset   asst\n    --   JOIN sales_force.account              acct\n    --     ON asst.cardconex_acct_id = acct.id\n    --  ORDER BY 1 * client_id\n    -- ;\n    \n    -- name                         |client_id|cardconex_acct_id |shieldconex_monthly_fee|shieldconex_monthly_minimum|shieldconex_transaction_fee|shieldconex_fields_fee|\n    -- -----------------------------|---------|------------------|-----------------------|---------------------------|---------------------------|----------------------|\n    -- Alaska Airlines - ShieldConex|20       |0013i00000IsUq7AAF|                0.00000|                  250.00000|                    0.02100|               0.00000|\n    -- PAAY LLC                     |33       |0013i00000QqgelAAB|                0.00000|                 5000.00000|                    0.00175|               0.00000|\n    \n    \n    -- All numeric columns:  INT UNSIGNED NOT NULL DEFAULT 0; no need for COALESCE function this time.\n    \n    SELECT 'populating temporary table 1' AS message;\n  \n    DROP TABLE IF EXISTS auto_billing_staging.tmp_shieldconex;\n    \n    CREATE TEMPORARY TABLE auto_billing_staging.tmp_shieldconex(\n         client_id               VARCHAR(16) NOT NULL\n        ,client_name             VARCHAR(64)\n        ,partner_name            VARCHAR(64)\n        ,total_bad_tokenized     INT UNSIGNED NOT NULL\n        ,total_good_detokenized  INT UNSIGNED NOT NULL\n        ,total_good_tokenized    INT UNSIGNED NOT NULL\n        ,total_bad_detokenized   INT UNSIGNED NOT NULL \n        ,good_tokenized_fields   INT UNSIGNED NOT NULL\n        ,bad_tokenized_fields    INT UNSIGNED NOT NULL\n        ,good_detokenized_fields INT UNSIGNED NOT NULL\n        ,bad_detokenized_fields  INT UNSIGNED NOT NULL\n        ,PRIMARY KEY(client_id)\n    );\n    \n    INSERT INTO auto_billing_staging.tmp_shieldconex\n    SELECT \n        client_id \n       ,client_name \n       ,partner_name\n       ,total_bad_tokenized \n       ,total_good_detokenized \n       ,total_good_tokenized     \n       ,total_bad_detokenized\n       ,good_tokenized_fields \n       ,bad_tokenized_fields \n       ,good_detokenized_fields \n       ,bad_detokenized_fields \n      FROM auto_billing_staging.stg_shieldconex\n     WHERE complete_date = DATE_FORMAT(CURRENT_DATE - INTERVAL 1 MONTH, '%Y%m01')\n       AND client_name NOT LIKE 'client_name%'\n    ;\n    \n    -- SELECT * FROM auto_billing_staging.tmp_shieldconex;\n    \n    -- client_id|client_name    |partner_name   |total_bad_tokenized|total_good_detokenized|total_good_tokenized|total_bad_detokenized|good_tokenized_fields|bad_tokenized_fields|good_detokenized_fields|bad_detokenized_fields|\n    -- ---------|---------------|---------------|-------------------|----------------------|--------------------|---------------------|---------------------|--------------------|-----------------------|----------------------|\n    -- 20       |Contact Centers|Alaska Airlines|                 61|                   132|                 132|                    0|                  528|                 244|                    528|                     0|\n    -- 33       |Paay           |Paay LLC       |                 18|                413372|              860487|                    7|               860487|                  18|                 413372|                     7|\n    \n    \n    -- identify client_id's which exist in sales_force.asset or auto_billing_staging.stg_shieldconex BUT NOT BOTH.\n    -- get a 'master list' of client_id's to start.\n    \n  \n    DROP TABLE IF EXISTS auto_billing_staging.tmp_client_id;\n    \n    CREATE TEMPORARY TABLE auto_billing_staging.tmp_client_id SELECT client_id FROM auto_billing_staging.tmp_asset UNION SELECT client_id FROM auto_billing_staging.tmp_shieldconex;\n    \n    -- SELECT * FROM auto_billing_staging.tmp_client_id;\n    \n    -- show a list of client_id's are missing data in one or more tables\n    SELECT \n         COALESCE(acct.name, 'NULL')                    AS account_name\n        ,sc.partner_name\n        ,t1.client_id                                   AS client_id\n        ,IF(sc.client_id IS NULL, 'missing', 'ok')      AS stg_shieldconex\n        ,IF(asst.client_id IS NULL, 'missing', 'ok')    AS asset \n        ,IF(idn.name IS NOT NULL, 'ok', 'missing')      AS identification_number__c\n        ,idn.type__c                                    AS identification_number_type__c\n      FROM auto_billing_staging.tmp_client_id           t1 \n      LEFT JOIN auto_billing_staging.tmp_asset          asst\n        ON t1.client_id = asst.client_id\n      LEFT JOIN sales_force.identification_number__c    idn \n        ON t1.client_id = idn.name\n      LEFT JOIN sales_force.account                     acct \n        ON idn.accountid__c = acct.id\n      LEFT JOIN auto_billing_staging.tmp_shieldconex    sc \n        ON t1.client_id = sc.client_id\n     WHERE idn.type__c = 'ShieldConex'\n        OR idn.type__c IS NULL\n     ORDER BY acct.name IS NULL, acct.name, 1 * t1.client_id\n    ;\n    \n    SELECT 'populating temporary table 2' AS message;\n  \n    DROP TABLE IF EXISTS auto_billing_staging.tmp_calc_shieldconex_charges;\n    \n    CREATE TABLE auto_billing_staging.tmp_calc_shieldconex_charges(\n       client_id                           VARCHAR(32)   NOT NULL,\n       cardconex_acct_id                   VARCHAR(18)   NOT NULL,\n       client_name                         VARCHAR(64)   DEFAULT NULL,\n       shieldconex_monthly_fee             DECIMAL(10,5) NOT NULL,\n       shieldconex_monthly_minimum         DECIMAL(10,5) NOT NULL,\n       shieldconex_transaction_fee         DECIMAL(10,5) NOT NULL,\n       shieldconex_fields_fee              DECIMAL(10,5) NOT NULL,\n       total_bad_tokenized                 INT UNSIGNED  NOT NULL,\n       total_good_detokenized              INT UNSIGNED  NOT NULL,\n       total_good_tokenized                INT UNSIGNED  NOT NULL,\n       total_bad_detokenized               INT UNSIGNED  NOT NULL,\n       good_tokenized_fields               INT UNSIGNED  NOT NULL,\n       bad_tokenized_fields                INT UNSIGNED  NOT NULL,\n       good_detokenized_fields             INT UNSIGNED  NOT NULL,\n       bad_detokenized_fields              INT UNSIGNED  NOT NULL,\n       shieldconex_monthly_charge          DECIMAL(10,5) NOT NULL DEFAULT 0.00000,\n       shieldconex_transaction_charge      DECIMAL(10,5) NOT NULL DEFAULT 0.00000,\n       shieldconex_monthly_minimum_charge  DECIMAL(10,5) NOT NULL DEFAULT 0.00000,\n       shieldconex_fields_charge           DECIMAL(10,5) NOT NULL DEFAULT 0.00000,\n       PRIMARY KEY(client_id),\n       UNIQUE(cardconex_acct_id)\n    )\n    ;\n    \n    -- DESC auto_billing_staging.tmp_calc_shieldconex_charges;\n    \n    INSERT INTO auto_billing_staging.tmp_calc_shieldconex_charges\n    SELECT \n         asst.client_id \n        ,asst.cardconex_acct_id \n        ,sc.client_name\n        ,asst.shieldconex_monthly_fee\n        ,asst.shieldconex_monthly_minimum\n        ,asst.shieldconex_transaction_fee\n        ,asst.shieldconex_fields_fee\n        ,sc.total_bad_tokenized    \n        ,sc.total_good_detokenized \n        ,sc.total_good_tokenized   \n        ,sc.total_bad_detokenized  \n        ,sc.good_tokenized_fields  \n        ,sc.bad_tokenized_fields   \n        ,sc.good_detokenized_fields\n        ,sc.bad_detokenized_fields \n        ,0.00000 AS shieldconex_monthly_charge\n        ,0.00000 AS shieldconex_transaction_charge\n        ,0.00000 AS shieldconex_monthly_minimum_charge\n        ,0.00000 AS shieldconex_fields_charge\n      FROM auto_billing_staging.tmp_asset                asst \n      LEFT JOIN auto_billing_staging.tmp_shieldconex     sc\n        ON asst.client_id = sc.client_id \n    ;\n    \n    SELECT 'calculating stage 1' AS message;\n  \n    UPDATE auto_billing_staging.tmp_calc_shieldconex_charges\n       SET shieldconex_monthly_charge = auto_billing_dw.calc_shieldconex_monthly_charge(shieldconex_monthly_fee) \n     WHERE TRUE\n    ;\n    \n    SELECT 'calculating stage 2' AS message;\n    \n    UPDATE auto_billing_staging.tmp_calc_shieldconex_charges\n       SET shieldconex_transaction_charge     = auto_billing_dw.calc_shieldconex_transaction_charge(\n              total_good_tokenized \n             ,total_bad_tokenized \n             ,total_good_detokenized\n             ,total_bad_detokenized \n             ,shieldconex_monthly_minimum\n             ,shieldconex_transaction_fee)    \n     WHERE TRUE\n    ;\n\n    SELECT 'calculating stage 3' AS message;\n  \n    UPDATE auto_billing_staging.tmp_calc_shieldconex_charges\n       SET shieldconex_monthly_minimum_charge = auto_billing_dw.calc_shieldconex_monthly_minimum_charge(\n              shieldconex_transaction_charge\n             ,shieldconex_monthly_minimum)\n     WHERE TRUE \n    ;\n\n    SELECT 'calculating stage 4' AS message;\n    \n    UPDATE auto_billing_staging.tmp_calc_shieldconex_charges\n       SET shieldconex_fields_charge = auto_billing_dw.calc_shieldconex_fields_charge(\n            good_tokenized_fields \n           ,bad_tokenized_fields \n           ,good_detokenized_fields \n           ,bad_detokenized_fields \n           ,shieldconex_monthly_minimum \n           ,shieldconex_fields_fee)\n     WHERE TRUE \n    ;\n    \n    \n--     SELECT * FROM auto_billing_staging.tmp_calc_shieldconex_charges;\n    -- client_id|cardconex_acct_id |client_name    |shieldconex_monthly_fee|shieldconex_monthly_minimum|shieldconex_transaction_fee|shieldconex_fields_fee|total_bad_tokenized|total_good_detokenized|total_good_tokenized|total_bad_detokenized|good_tokenized_fields|bad_tokenized_fields|good_detokenized_fields|bad_detokenized_fields|shieldconex_monthly_charge|shieldconex_transaction_charge|shieldconex_monthly_minimum_charge|shieldconex_fields_charge|\n    -- ---------|------------------|---------------|-----------------------|---------------------------|---------------------------|----------------------|-------------------|----------------------|--------------------|---------------------|---------------------|--------------------|-----------------------|----------------------|--------------------------|------------------------------|----------------------------------|-------------------------|\n    -- 20       |0013i00000IsUq7AAF|Contact Centers|                0.00000|                  250.00000|                    0.02100|               0.00000|                 61|                   132|                 132|                    0|                  528|                 244|                    528|                     0|                   0.00000|                       0.00000|                         250.00000|                  0.00000|\n    -- 33       |0013i00000QqgelAAB|Paay           |                0.00000|                 5000.00000|                    0.00175|               0.00000|                 18|                413372|              860487|                    7|               860487|                  18|                 413372|                     7|                   0.00000|                       0.00000|                        5000.00000|                  0.00000|\n    \n    SELECT 'updating auto_billing_dw.f_auto_billing_complete_2' AS message; \n      \n    INSERT INTO auto_billing_dw.f_auto_billing_complete_2 (\n         decryptx \n        ,payconex \n        ,shieldconex\n        ,bill_to_id\n        ,bill_to_name\n        ,collection_method\n        ,start_date\n        ,vintage_v2\n        ,hold_bill\n        ,segment_intacct\n--         ,id\n        ,segment_now\n        ,org_now\n        ,chain_now\n        ,industry_now\n        ,dba_name\n        ,year_mon\n        ,account_id\n        ,account_name\n        ,payconex_acct_id\n        ,payconex_acct_name\n        ,payconex_acct_ids\n        ,pci_non_compliance_charge\n        ,shieldconex_monthly_charge\n        ,shieldconex_transaction_charge\n        ,shieldconex_monthly_minimum_charge\n        ,shieldconex_fields_charge\n        ,p2pe_encryption_charge\n        ,p2pe_token_flat_monthly_charge\n        ,p2pe_token_flat_charge\n        ,achworks_credit_charge\n        ,achworks_per_trans_charge\n        ,ach_returnerror_charge\n        ,ach_noc_message_charge\n        ,achworks_monthly_charge\n        ,ach_sale_volume_charge\n        ,cc_sale_charge\n        ,group_charge\n        ,gw_reissued_charge\n        ,gw_reissued_ach_trans_charge\n        ,p2pe_token_charge\n        ,apriva_monthly_charge\n        ,file_transfer_monthly_charge\n        ,misc_monthly_charge\n        ,pc_account_updater_monthly_charge\n        ,pci_scans_monthly_charge\n        ,card_convenience_charge\n        ,gw_monthly_charge\n        ,gw_per_auth_charge\n        ,gw_per_auth_decline_charge\n        ,gw_per_refund_charge\n        ,gw_per_credit_charge\n        ,gw_per_token_charge\n        ,p2pe_device_activated_charge\n        ,p2pe_device_activating_charge\n        ,p2pe_device_stored_charge\n        ,pricing_ach_credit_fee\n        ,pricing_ach_discount_rate\n        ,pricing_ach_monthly_fee\n        ,pricing_ach_noc_fee\n        ,pricing_ach_per_gw_trans_fee\n        ,pricing_ach_return_error_fee\n        ,pricing_ach_transaction_fee\n        ,pricing_bluefin_gateway_discount_rate\n        ,pricing_file_transfer_monthly_fee\n        ,pricing_gateway_monthly_fee\n        ,pricing_group_tag_fee\n        ,pricing_gw_per_auth_decline_fee\n        ,pricing_per_transaction_fee\n        ,pricing_gw_per_credit_fee\n        ,pricing_gw_per_refund_fee\n        ,pricing_gw_per_sale_fee\n        ,pricing_gw_per_token_fee\n        ,pricing_gw_reissued_fee\n        ,pricing_misc_monthly_fee\n        ,pricing_p2pe_device_activated_fee\n        ,pricing_p2pe_device_activating_fee\n        ,pricing_p2pe_device_stored_fee\n        ,pricing_p2pe_encryption_fee\n        ,pricing_p2pe_monthly_flat_fee\n        ,pricing_one_time_key_injection_fee\n        ,pricing_p2pe_tokenization_fee\n        ,pricing_pci_scans_monthly_fee\n        ,pricing_pc_acct_updater_fee\n        ,pricing_pci_compliance_fee\n        ,pricing_pci_non_compliance_fee\n        ,pricing_shieldconex_monthly_fee\n        ,pricing_shieldconex_transaction_fee\n        ,pricing_shieldconex_fields_fee\n        ,pricing_shieldconex_monthly_minimum_fee\n        ,total_good_tokenized\n        ,total_bad_tokenized\n        ,total_good_detokenized\n        ,total_bad_detokenized\n        ,total_good_tokenized_fields\n        ,total_bad_tokenized_fields\n        ,total_good_detokenized_fields\n        ,total_bad_detokenized_fields\n        ,decryption_count\n        ,device_activated_count\n        ,device_activating_count\n        ,device_stored_count\n        ,device_other_count\n        ,device_activating_activated_count\n        ,device_stored_activated_count\n        ,device_other_activated_count\n        ,user_count\n        ,group_count\n        ,cc_auth_trans\n        ,cc_auth_vol\n        ,cc_sale_trans\n        ,cc_sale_vol\n        ,cc_ref_trans\n        ,cc_ref_vol\n        ,cc_credit_trans\n        ,cc_credit_vol\n        ,cc_sale_decline_trans\n        ,cc_auth_decline_trans\n        ,cc_batches\n        ,cc_keyed_trans\n        ,cc_keyed_vol\n        ,cc_swiped_trans\n        ,cc_swiped_vol\n        ,ach_sale_trans\n        ,ach_sale_vol\n        ,ach_credit_trans\n        ,ach_credit_vol\n        ,ach_batches\n        ,ach_returns\n        ,ach_errors\n        ,ach_noc_messages\n        ,p2pe_auth_trans\n        ,p2pe_auth_vol\n        ,p2pe_sale_trans\n        ,p2pe_sale_vol\n        ,p2pe_refund_trans\n        ,p2pe_refund_vol\n        ,p2pe_credit_trans\n        ,p2pe_credit_vol\n        ,p2pe_sale_decline_trans\n        ,p2pe_auth_decline_trans\n        ,p2pe_active_device_trans\n        ,p2pe_inactive_device_trans\n        ,tokens_stored\n        ,batch_files_processed\n        ,cc_capture_trans\n        ,cc_capture_vol \n        ,p2pe_capture_trans\n        ,p2pe_capture_vol\n        ,combined_decline_trans\n        ,p2pe_declined_trans\n        ,p2pe_tokens_stored\n        ,reissued_cc_transactions\n        ,reissued_ach_transactions\n    ) \n    SELECT \n         0\n        ,0\n        ,1\n        ,NULL\n        ,NULL\n        ,NULL\n        ,NULL\n        ,NULL\n        ,NULL\n        ,NULL\n--         ,NULL  -- id\n        ,NULL\n        ,NULL\n        ,NULL\n        ,NULL\n        ,NULL\n        ,DATE_FORMAT(CURRENT_DATE, '%Y%m')\n        ,cardconex_acct_id\n        ,NULL\n        ,NULL\n        ,NULL\n        ,NULL\n        ,0\n        ,shieldconex_monthly_charge\n        ,shieldconex_transaction_charge\n        ,shieldconex_monthly_minimum_charge\n        ,shieldconex_fields_charge\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,shieldconex_monthly_fee\n        ,shieldconex_transaction_fee\n        ,shieldconex_fields_fee\n        ,shieldconex_monthly_minimum\n        ,total_good_tokenized\n        ,total_bad_tokenized\n        ,total_good_detokenized\n        ,total_bad_detokenized\n        ,good_tokenized_fields\n        ,bad_tokenized_fields\n        ,good_detokenized_fields\n        ,bad_detokenized_fields\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n        ,0\n    FROM auto_billing_staging.tmp_calc_shieldconex_charges\n    ;\n  \nEND	utf8	utf8_general_ci	latin1_swedish_ci

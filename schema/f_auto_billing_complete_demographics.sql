Procedure	sql_mode	Create Procedure	character_set_client	collation_connection	Database Collation
f_auto_billing_complete_demographics	STRICT_TRANS_TABLES	CREATE DEFINER=`data_warehouse`@`172.16.63.%` PROCEDURE `f_auto_billing_complete_demographics`()\nBEGIN\n  \n    -- bill_to_name \n    \n    SELECT 'Executing Stored Procedure' AS operation, 'f_auto_billing_complete_demographics' AS stored_procedure, CURRENT_TIMESTAMP;\n    \n    SELECT 'updating bill_to_id' AS stage, CURRENT_TIMESTAMP;\n    \n    UPDATE auto_billing_dw.f_auto_billing_complete_2    abc \n      JOIN sales_force.account                          acct\n        ON abc.bill_to_id   = acct.id \n       SET abc.bill_to_name = acct.name \n     WHERE TRUE \n    ;\n        \n    -- columns originating in sales_force.account\n    SELECT 'updating columns = f(sales_force.account)' AS stage, CURRENT_TIMESTAMP;\n    \n    UPDATE auto_billing_dw.f_auto_billing_complete_2    abc \n      JOIN sales_force.account                          acct\n        ON abc.account_id        = acct.id \n       SET abc.account_name      = acct.name\n          ,abc.dba_name          = acct.dba_name__c\n          ,abc.collection_method = acct.collection_method__c \n          ,abc.hold_bill         = acct.hold_billing__c\n          ,abc.industry_now      = acct.industry\n          ,abc.segment_now       = acct.revenue_segment__c \n          ,abc.start_date        = 19700101                     -- needs to be changed to acct.bluefin_contract_start_date when that column has been added to acct\n     WHERE TRUE \n    ;\n    \n    \n    -- org_now\n    SELECT 'updating org_now' AS stage, CURRENT_TIMESTAMP;\n    \n    UPDATE auto_billing_dw.f_auto_billing_complete_2        abc \n      JOIN sales_force.account                              acct \n        ON abc.account_id = acct.id \n      JOIN sales_force.organization__c                      org \n        ON acct.organizationid__c = org.id \n       SET abc.org_now = org.name \n    WHERE TRUE \n    ;\n    \n    -- payconex \n    \n    DROP TABLE IF EXISTS auto_billing_dw.tmp_payconex_01;\n    \n    SELECT 'creating temporary table tmp_payconex_01' AS stage, CURRENT_TIMESTAMP;\n    \n    CREATE TEMPORARY TABLE auto_billing_dw.tmp_payconex_01(\n         payconex_acct_id       VARCHAR(20)\n        ,payconex_acct_name     VARCHAR(255)  \n        ,account_id             VARCHAR(18)    \n        ,max_cc_sale_vol        DECIMAL(15, 4) \n        ,PRIMARY KEY(payconex_acct_id)\n    );\n        \n    SELECT 'populating tmp_payconex_01' AS stage, CURRENT_TIMESTAMP;\n    \n    INSERT INTO auto_billing_dw.tmp_payconex_01(payconex_acct_id, max_cc_sale_vol)\n    SELECT\n         pcm.payconex_acct_id \n        ,MAX(abc.cc_sale_vol) AS max_cc_sale_vol\n      FROM auto_billing_dw.f_auto_billing_complete_2          abc \n      JOIN auto_billing_staging.stg_payconex_cardconex_map    pcm\n        ON abc.account_id = pcm.cardconex_acct_id \n      JOIN auto_billing_staging.stg_payconex_volume           pv \n        ON pcm.payconex_acct_id = pv.acct_id \n     GROUP BY 1\n    ;\n    \n    SELECT 'updating account_id' AS stage, CURRENT_TIMESTAMP;\n    \n    UPDATE auto_billing_dw.tmp_payconex_01                      t01 \n      JOIN auto_billing_staging.stg_payconex_cardconex_map      pcm \n        ON t01.payconex_acct_id = pcm.payconex_acct_id \n       SET t01.account_id = pcm.cardconex_acct_id \n     WHERE TRUE \n    ;\n      \n    SELECT 'updating account_name' AS stage, CURRENT_TIMESTAMP;\n    \n    UPDATE auto_billing_dw.tmp_payconex_01                  t01\n      JOIN auto_billing_staging.stg_payconex_volume         pv \n        ON t01.payconex_acct_id = pv.acct_id \n       SET t01.payconex_acct_name = pv.acct_name\n     WHERE TRUE \n    ;\n    \n    SELECT 'updating payconex_acct_id, payconex_acct_name' AS stage, CURRENT_TIMESTAMP;\n      \n    UPDATE auto_billing_dw.f_auto_billing_complete_2      abc \n      JOIN auto_billing_dw.tmp_payconex_01                t01 \n        ON abc.account_id = t01.account_id \n       AND t01.max_cc_sale_vol = abc.cc_sale_vol\n       SET abc.payconex_acct_id = t01.payconex_acct_id \n          ,abc.payconex_acct_name = t01.payconex_acct_name  \n     WHERE TRUE \n    ;\n    \n    SET SESSION group_concat_max_len = 102400;\n  \n    SELECT 'updating payconex_acct_ids' AS stage, CURRENT_TIMESTAMP;\n    \n    UPDATE auto_billing_dw.f_auto_billing_complete_2      abc \n      JOIN (\n            SELECT \n                 pcm.cardconex_acct_id                                                  AS account_id\n                ,LEFT(GROUP_CONCAT(pv.acct_id ORDER BY pv.cc_sale_vol DESC SEPARATOR ' | '), 74) AS payconex_acct_ids\n                ,COUNT(*)\n              FROM auto_billing_staging.stg_payconex_volume           pv \n              JOIN auto_billing_staging.stg_payconex_cardconex_map    pcm\n                ON pv.acct_id = pcm.payconex_acct_id \n             GROUP BY 1  \n      ) t0 \n        ON abc.account_id = t0.account_id \n       SET abc.payconex_acct_ids = t0.payconex_acct_ids\n     WHERE TRUE \n    ;\n  \n    SELECT 'updating year_mon' AS stage, CURRENT_TIMESTAMP;\n    UPDATE auto_billing_dw.f_auto_billing_complete_2 \n       SET year_mon = DATE_FORMAT(CURRENT_DATE - INTERVAL 1 MONTH, '%Y%m')\n     WHERE TRUE\n    ;\n  \n  \nEND	utf8	utf8_general_ci	latin1_swedish_ci
